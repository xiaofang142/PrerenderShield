version: '3.8'

services:
  prerender-shield:
    # 使用本地构建而不是预构建镜像
    build:
      context: .
      args:
        - PUBLIC_IP=${HOST_IP}
    container_name: prerender-shield
    restart: unless-stopped
    ports:
      - "9597:9597"  # 管理控制台前端
      - "9598:9598"  # API服务
    volumes:
      - ./data:/app/data
      - ./configs:/app/configs
      - ./certs:/app/certs
    environment:
      - CONFIG_PATH=/app/configs/config.yml
      - REDIS_HOST=prerender-shield-redis  # 使用容器名称访问Redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - API_PUBLIC_URL=http://${HOST_IP:-localhost}:9598  # 公网IP配置
    depends_on:
      - redis
    networks:
      - prerender-shield-network
    command: ./api --config /app/configs/config.yml

  redis:
    image: redis:7.2-alpine
    container_name: prerender-shield-redis
    restart: unless-stopped
    volumes:
      - ./data/redis:/data
      - ./data/redis/redis.conf:/etc/redis/redis.conf:ro
    command: redis-server /etc/redis/redis.conf
    networks:
      - prerender-shield-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  prerender-shield-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.27.0.0/16
