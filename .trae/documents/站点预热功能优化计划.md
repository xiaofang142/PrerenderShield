# 站点预热功能优化计划

## 1. 后端优化

### 1.1 异步执行预热任务
- **修改**：将`/api/v1/preheat/trigger`接口改为异步执行
- **实现**：
  - 移除当前同步执行的`Start()`方法，改为创建异步任务
  - 立即返回任务ID给前端，避免超时
  - 使用goroutine后台执行预热任务
  - 任务状态存储在Redis中，包括进度、状态和结果

### 1.2 使用无头浏览器获取URL
- **修改**：将当前的HTTP请求方式改为使用无头浏览器获取网站所有URL
- **实现**：
  - 集成现有的浏览器池功能，复用浏览器实例
  - 实现基于无头浏览器的URL爬取，支持深度配置
  - 支持动态JS渲染的网站URL获取
  - 基于站点独立配置的预热参数执行操作

### 1.3 优化并发处理
- **修改**：利用Go channel特性优化并发访问
- **实现**：
  - 实现基于站点配置的并发数控制
  - 使用channel管理并发访问，避免资源耗尽
  - 实现请求超时和错误重试机制
  - 优化爬虫协议头管理，支持自定义和随机选择

### 1.4 系统启动自动预热
- **修改**：系统启动时开启守护进程，循环处理每个站点的预热任务
- **实现**：
  - 实现站点配置的自动预热开关
  - 支持基于定时规则的自动预热
  - 利用channel特性实现高效并发处理
  - 实现预热任务的优先级管理

## 2. 前端优化

### 2.1 优化UI交互和进度显示
- **修改**：改进预热进度显示，提供实时反馈
- **实现**：
  - 实现预热任务的实时进度显示
  - 支持任务取消功能
  - 优化进度条和状态提示
  - 实现预热结果的详细报告

### 2.2 简化URL列表展示
- **修改**：优化URL列表的显示内容和交互
- **实现**：
  - 移除站点名称显示（冗余信息）
  - 移除删除按钮、重新预热按钮和状态按钮
  - 添加缓存大小、更新时间和到期时间显示
  - 优化列表排序和筛选功能

### 2.3 优化站点配置界面
- **修改**：改进站点预热配置的UI设计
- **实现**：
  - 集成自动预热开关
  - 支持并发数、深度、爬虫协议头等参数配置
  - 提供预热历史记录和统计数据
  - 优化配置保存和验证逻辑

## 3. 数据管理优化

### 3.1 优化Redis数据结构
- **修改**：改进预热相关数据的存储结构
- **实现**：
  - 优化URL列表存储，添加缓存大小、更新时间和到期时间
  - 实现预热任务状态的高效存储和查询
  - 优化统计数据的存储结构，支持快速查询
  - 实现数据过期自动清理机制

### 3.2 改进数据同步机制
- **修改**：确保前后端数据的一致性
- **实现**：
  - 实现实时数据同步机制
  - 优化数据查询性能
  - 实现数据变更通知机制
  - 确保数据的可靠性和一致性

## 4. 代码结构优化

### 4.1 模块化设计
- **修改**：优化预热功能的代码结构
- **实现**：
  - 分离预热任务管理、URL爬取、并发处理等功能
  - 实现清晰的接口定义和依赖管理
  - 优化代码复用和扩展性
  - 实现完善的错误处理和日志记录

### 4.2 性能优化
- **修改**：优化预热功能的性能
- **实现**：
  - 优化浏览器资源管理，避免内存泄漏
  - 实现高效的并发控制
  - 优化网络请求和数据处理
  - 实现资源的合理分配和释放

## 5. 测试和监控

### 5.1 完善测试用例
- **修改**：添加全面的测试用例
- **实现**：
  - 单元测试：测试各个组件的功能
  - 集成测试：测试整个预热流程
  - 性能测试：测试并发处理和性能表现
  - 可靠性测试：测试长时间运行的稳定性

### 5.2 实现监控和告警
- **修改**：添加预热功能的监控和告警
- **实现**：
  - 监控预热任务的执行状态和性能
  - 实现异常情况的告警机制
  - 提供详细的日志记录和分析
  - 实现资源使用的监控和优化

## 实现步骤

1. **后端异步任务实现**：修改trigger preheat接口，实现异步执行
2. **无头浏览器URL爬取**：集成浏览器池，实现基于无头浏览器的URL获取
3. **前端进度显示**：优化前端UI，实现实时进度显示
4. **URL列表优化**：简化URL列表展示，只显示必要信息
5. **系统启动自动预热**：实现系统启动时的守护进程，自动执行预热任务
6. **代码结构优化**：重构预热相关代码，实现模块化设计
7. **测试和监控**：添加测试用例和监控告警机制

## 预期效果

1. **性能提升**：异步执行避免超时，提高系统响应速度
2. **用户体验优化**：实时进度显示，提供良好的交互反馈
3. **功能完善**：支持无头浏览器URL获取，提高URL覆盖率
4. **自动化程度提高**：系统自动执行预热任务，减少人工干预
5. **代码可维护性提升**：模块化设计，便于后续扩展和维护

## 技术栈

- **后端**：Go、Gin、Redis、无头浏览器（rod库）
- **前端**：React、TypeScript、Ant Design
- **数据库**：Redis

## 注意事项

1. 确保浏览器资源的合理管理，避免内存泄漏
2. 实现完善的错误处理和重试机制
3. 优化网络请求，避免对目标网站造成过大压力
4. 确保数据的一致性和可靠性
5. 实现完善的日志记录和监控

通过以上优化，站点预热功能将更加高效、可靠和易用，能够更好地满足用户需求，提高系统性能和用户体验。