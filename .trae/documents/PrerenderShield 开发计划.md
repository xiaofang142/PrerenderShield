# PrerenderShield 开发计划

## 一、初始化逻辑改进

### 1. 端口配置调整
- 修改 `configs/config.example.yml`，添加管理控制台和API服务的端口配置
- 更新 `internal/config/config.go`，添加相应的配置结构体
- 修改 `cmd/api/main.go`，实现两个服务端口（9597和9598）的监听

### 2. 静态资源服务器实现
- 在 `cmd/api/main.go` 中添加静态资源服务器，用于提供管理控制台前端代码
- 配置前端资源目录，支持开发和生产环境

### 3. 一键发布脚本
- 编写 `release.sh` 脚本，实现：
  - 多端Go代码编译
  - 前端代码编译（调用 `npm run build`）
  - 打包发布文件

### 4. 启动脚本优化
- 完善现有 `start.sh` 脚本，确保支持所有功能选项
- 实现 `reinstall` 选项，能够清除数据重新初始化

### 5. 首次访问设置
- 在 `internal/auth/user.go` 中完善 `IsFirstRun` 逻辑
- 更新前端登录页面，支持首次访问时设置用户名密码
- 实现JWT认证的完整流程

## 二、渲染预热逻辑增强

### 1. 爬虫协议头配置
- 在 `internal/prerender/engine.go` 中添加默认爬虫协议头
- 实现自定义爬虫协议头的支持
- 确保每个站点可以独立配置

### 2. 渲染预热配置集成
- 修改前端站点管理页面，添加渲染预热配置按钮
- 实现渲染预热配置的CRUD接口
- 确保配置能够实时生效

### 3. 爬虫访问日志
- 在 `internal/monitoring/monitor.go` 中添加爬虫访问日志记录
- 实现Redis存储爬虫访问记录
- 添加异步日志记录机制，不影响性能

### 4. 爬虫访问统计页面
- 前端添加"爬虫访问"一级菜单
- 实现折线图展示（支持天/周/月切换）
- 实现访问记录列表，支持分页和站点筛选
- 添加15天自动清理任务

## 三、WAF产品强化

### 1. 地理位置访问控制
- 集成IP地理位置库
- 在 `internal/firewall/engine.go` 中添加地理位置规则支持
- 实现基于国家/地区的访问控制

### 2. 实时可视化大屏
- 将流量统计页面移至首页首屏
- 实现网站访问量地域分布数据展示
- 使用ECharts绘制地图和图表

### 3. 频率限制/CC攻击防护
- 在 `internal/firewall/engine.go` 中添加频率限制功能
- 实现基于IP和URL的访问频率控制
- 添加CC攻击检测和防护机制

### 4. 网页防篡改
- 实现网页文件完整性检测
- 添加文件哈希校验机制
- 实现篡改告警功能

### 5. 多域名支持
- 优化站点配置，支持每个站点绑定多个域名
- 实现域名解析和路由转发

## 四、Docker部署优化

### 1. Dockerfile更新
- 确保Dockerfile能够正确构建包含前端资源的镜像
- 优化镜像大小和构建速度

### 2. Docker-compose配置
- 确保 `docker-compose.yml` 正确映射9597和9598端口
- 完善卷挂载配置，确保数据持久化
- 优化网络配置，确保容器间通信正常

## 五、开发和测试

### 1. 开发环境配置
- 配置本地开发环境，支持前后端联调
- 实现热重载功能，提高开发效率

### 2. 测试用例
- 编写单元测试，确保核心功能的正确性
- 实现集成测试，验证各模块协同工作
- 进行性能测试，确保系统能够处理高并发请求

## 六、文档更新

### 1. 功能文档
- 更新 `功能文档.md`，详细描述所有功能
- 添加使用指南和最佳实践

### 2. 开发文档
- 更新 `开发文档.md`，描述开发流程和规范
- 添加API文档，便于前端开发

### 3. 部署文档
- 编写详细的部署指南，包括bash安装和docker安装
- 添加常见问题解决方法

## 开发顺序

1. 首先完成初始化逻辑改进，确保基本架构正确
2. 然后实现渲染预热逻辑增强，完善核心功能
3. 接着进行WAF产品强化，提升安全性能
4. 最后优化Docker部署和文档

## 预期成果

- 实现所有需求功能，包括初始化逻辑、渲染预热逻辑和WAF强化
- 提供完整的部署和使用文档
- 确保系统稳定可靠，能够处理高并发请求
- 提供良好的用户体验，包括直观的管理界面和详细的统计信息