# 渲染预热功能实现方案

## 一、功能概述
实现基于无头浏览器的渲染预热功能，包括链接爬取、Redis存储、模拟爬虫访问和定时更新，提升静态网站的SEO表现和访问速度。

## 二、技术栈
- 后端：Go语言 + go-rod（无头浏览器） + Redis
- 前端：React + Ant Design

## 三、核心功能实现

### 1. 后端核心模块

#### 1.1 链接爬取模块
- **文件**：`internal/prerender/crawler.go`
- **功能**：使用go-rod无头浏览器递归爬取指定站点的所有链接
- **实现**：
  - 实现`Crawler`结构体，管理爬取任务
  - 递归爬取页面所有`<a>`标签的`href`属性
  - 去重逻辑，使用Redis Set存储已爬取链接
  - 支持深度限制和并发控制

#### 1.2 Redis存储模块
- **文件**：`internal/redis/client.go`
- **功能**：实现Redis客户端，用于存储链接和预热状态
- **实现**：
  - 连接池管理
  - 链接存储：使用Set数据结构存储每个站点的链接
  - 预热状态存储：使用Hash存储URL的预热状态、缓存时间等
  - 统计数据存储：使用Hash存储站点的URL数量、缓存数量等

#### 1.3 预热执行模块
- **文件**：`internal/prerender/preheat.go`
- **功能**：模拟爬虫协议头访问链接，生成缓存
- **实现**：
  - 从Redis获取站点链接列表
  - 并发模拟爬虫访问（利用Go协程）
  - 支持多种爬虫协议头（百度蜘蛛、谷歌蜘蛛等）
  - 记录预热结果到Redis

#### 1.4 定时任务模块
- **文件**：`internal/scheduler/scheduler.go`
- **功能**：基于预渲染缓存时间间隔，定时执行预热任务
- **实现**：
  - 解析`PreheatConfig.Schedule` cron表达式
  - 定时触发指定站点的预热任务
  - 支持动态调整任务间隔

#### 1.5 API接口模块
- **文件**：`cmd/api/handlers/preheat.go`
- **功能**：提供前端调用的RESTful API
- **实现**：
  - 站点列表接口（仅返回静态模式站点）
  - 预热状态查询接口
  - 手动触发预热接口
  - URL列表查询接口
  - 统计数据查询接口

### 2. 前端UI实现

#### 2.1 页面布局
- **文件**：`web/src/pages/Prerender/Preheat.tsx`
- **布局**：
  - 站点选择栏：下拉选择静态网站站点，刷新按钮
  - 统计数据卡片：URL总数、缓存数、缓存大小、浏览器池大小
  - 手动操作区：手动渲染输入框，支持批量URL输入
  - URL列表：带分页的URL列表，显示URL和站点名称

#### 2.2 交互功能
- 站点选择后自动加载统计数据和URL列表
- 手动输入URL后可立即触发渲染预热
- 支持选择多个站点或全部站点进行预热
- 实时更新统计数据和预热状态

## 四、代码结构调整

### 1. 新增文件
- `internal/prerender/crawler.go` - 链接爬取模块
- `internal/redis/client.go` - Redis客户端实现
- `internal/scheduler/scheduler.go` - 定时任务调度
- `cmd/api/handlers/preheat.go` - 预热相关API接口
- `web/src/pages/Prerender/Preheat.tsx` - 预热功能UI页面

### 2. 修改现有文件
- `internal/prerender/engine.go` - 完善PreheatManager功能
- `internal/config/config.go` - 扩展配置结构
- `web/src/pages/Prerender/Prerender.tsx` - 添加预热功能入口

## 五、实现步骤

1. **Redis客户端实现**：实现Redis连接和基本操作
2. **链接爬取模块**：实现递归爬取和去重逻辑
3. **预热执行模块**：实现模拟爬虫访问功能
4. **定时任务模块**：实现基于cron的任务调度
5. **API接口**：实现前端调用的RESTful API
6. **前端UI**：实现预热功能的用户界面
7. **集成测试**：测试各模块协同工作

## 六、关键技术点

1. **并发控制**：使用Go协程池控制并发爬取和预热任务，避免资源耗尽
2. **链接去重**：使用Redis Set实现高效的链接去重
3. **爬虫协议头模拟**：支持多种主流爬虫的User-Agent
4. **定时任务调度**：基于cron表达式实现灵活的定时任务
5. **进度监控**：实时监控爬取和预热进度，反馈给前端
6. **错误处理**：完善的错误处理机制，确保系统稳定性

## 七、预期效果

1. 静态网站站点可通过UI界面轻松配置和管理渲染预热
2. 系统自动爬取站点所有链接并缓存，提升SEO表现
3. 定时更新机制确保缓存始终保持最新
4. 支持手动干预，满足特殊场景需求
5. 提供详细的统计数据和进度监控

## 八、注意事项

1. 爬取深度和并发数需可配置，避免对目标站点造成过大压力
2. 支持断点续爬，避免重复爬取
3. 完善的日志记录，便于问题排查
4. 考虑不同站点的robots.txt规则
5. 支持分布式部署，满足大规模站点需求