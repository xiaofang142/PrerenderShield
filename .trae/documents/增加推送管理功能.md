# 推送管理功能实现计划

## 1. 配置结构设计

### 1.1 在 `internal/config/config.go` 中添加推送配置结构
- 在 `PrerenderConfig` 结构体中添加 `Push` 字段
- 创建 `PushConfig` 结构体，包含：
  - `Enabled`: 是否启用推送功能
  - `BaiduAPI`: 百度推送API地址
  - `BaiduToken`: 百度推送token
  - `BingAPI`: 必应推送API地址
  - `BingToken`: 必应推送token
  - `DailyLimit`: 每日推送限制条数
  - `PushDomain`: 用于推送的域名

### 1.2 在默认配置中添加推送配置
- 在 `defaultConfig()` 函数中为每个站点添加默认推送配置

## 2. 后端实现

### 2.1 推送管理模块
- 创建 `internal/prerender/push` 目录
- 实现 `PushManager` 类，负责推送逻辑
- 实现 `PushTask` 结构体，用于记录推送任务
- 实现 `PushLog` 结构体，用于记录推送日志

### 2.2 API 端点实现
- 在 `cmd/api/handlers` 中添加 `push.go`
- 实现以下API端点：
  - `GET /push/sites`: 获取站点列表
  - `GET /push/stats`: 获取推送统计数据
  - `GET /push/logs`: 获取推送日志
  - `POST /push/trigger`: 手动触发推送
  - `GET /push/config`: 获取推送配置
  - `POST /push/config`: 更新推送配置

### 2.3 定时任务实现
- 在 `internal/scheduler/scheduler.go` 中添加推送任务调度
- 每天按照站点配置的定时规则执行推送

### 2.4 URL处理逻辑
- 确保爬取的URL只保留路由部分（去除域名）
- 预热时使用 `127.0.0.1:端口+路由` 格式
- 推送时使用 `PushDomain+路由` 格式

## 3. 前端实现

### 3.1 站点配置页面
- 在 `web/src/pages/Sites/Sites.tsx` 中添加推送配置表单
- 在预热配置之后添加推送配置选项
- 实现推送配置的保存和加载

### 3.2 推送管理页面
- 创建 `web/src/pages/Prerender/Push.tsx`
- 实现站点选择功能
- 实现推送统计展示
- 实现推送日志列表
- 实现手动触发推送功能

### 3.3 API 客户端
- 在 `web/src/api` 中添加推送相关API调用

## 4. 数据存储

### 4.1 Redis 键设计
- `prerender:{siteName}:push:config`: 站点推送配置
- `prerender:{siteName}:push:stats`: 站点推送统计
- `prerender:{siteName}:push:logs`: 站点推送日志

### 4.2 推送日志字段
- `id`: 日志ID
- `siteName`: 站点名称
- `url`: 推送的完整URL
- `route`: 路由部分
- `searchEngine`: 搜索引擎（baidu/bing）
- `status`: 推送状态（success/failed）
- `message`: 推送结果消息
- `pushTime`: 推送时间

## 5. 实现步骤

1. **配置结构修改**：添加推送配置结构体
2. **后端模块实现**：创建推送管理模块
3. **API端点实现**：添加推送相关API
4. **前端页面实现**：添加推送配置和管理页面
5. **定时任务实现**：添加推送任务调度
6. **URL处理优化**：确保URL只保留路由部分
7. **测试验证**：测试推送功能的完整性

## 6. 特殊说明

- 确保爬取的URL只保留路由部分，用于缓存key和推送
- 预热时使用 `127.0.0.1:端口+路由` 模拟内部访问
- 推送时使用配置的域名+路由生成完整URL
- 80端口需要特殊处理，生成URL时不需要显示端口号
- 每个站点独立配置推送参数和每日限制
- 推送日志需要包含站点名称、推送URL、推送时间等信息